# Implementation Prompt: Unify Trip Model Across Core and Frontend (Pydantic 2.12.3 + Zod 4.1.12 Discriminated Unions)

**Objective:** Consolidate all Trip data representations into a single Pydantic 2.12.3 strict model with discriminated unions in the core, synced to Zod 4.1.12 discriminated unions with codecs for transformations in the frontend, eliminating field duplication, ensuring type-safe API-to-UI flows, and integrating Supabase 2.76.1 RLS for all Trip operations without custom auth code.

## Detailed Instructions  

1. **File to Modify/Delete:** `tripsage_core/models/trip.py`  
   * **Action:** Refactor the `Trip` class to use Pydantic 2.12.3 strict configuration and discriminated unions for status-based variants, incorporating all fields from API schemas and ensuring compatibility with SQLAlchemy 2.0.44 async models.  
   * **Specifics:** Import necessary modules: `from pydantic import BaseModel, Field, ConfigDict; from typing import Literal, Union, Annotated; from enum import Enum; from sqlalchemy import UUID, ForeignKey; from sqlalchemy.orm import Mapped, mapped_column, relationship; from sqlalchemy.ext.asyncio import AsyncAttrs; from datetime import datetime; from typing import Optional;`. Define enum: `class TripStatus(str, Enum): ACTIVE = "active"; CANCELLED = "cancelled";`. Base model: `class Trip(BaseModel): model_config = ConfigDict(from_attributes=True, strict=True, json_schema_extra={"examples": [{"status": "active", "title": "Beach Getaway", "user_id": "uuid-example", "id": 1, "start_date": "2025-01-01T00:00:00Z"}]}); id: int = Field(gt=0, description="Unique Trip ID"); user_id: UUID = Field(description="Associated User ID"); status: TripStatus = Field(default=TripStatus.ACTIVE, description="Trip status"); title: str = Field(min_length=1, max_length=255, description="Trip title"); start_date: Optional[datetime] = Field(default=None, description="Trip start date"); end_date: Optional[datetime] = Field(default=None, description="Trip end date"); preferences: Optional[dict] = Field(default={}, description="User preferences"); duration_days: Optional[int] = Field(default=None, description="Computed duration in days");`. Discriminated unions (docs: docs.pydantic.dev/latest/concepts/unions/#discriminated-unions): `TripActive = Annotated[Trip, Field(discriminator='status')].model_copy(update={"status": Literal["active"]}); TripCancelled = Annotated[Trip, Field(discriminator='status')].model_copy(update={"status": Literal["cancelled"]}); TripResponse = Annotated[Union[TripActive, TripCancelled], Field(discriminator='status')];`. SQLAlchemy integration: `class TripDB(AsyncAttrs, Trip, table=True): __tablename__ = "trips"; id: Mapped[int] = mapped_column(primary_key=True); user_id: Mapped[UUID] = mapped_column(ForeignKey("users.id")); user: Mapped["User"] = relationship(back_populates="trips"); # For eager loading in queries`. Export: `TripResponse.model_validate(data)` for parsing in endpoints.  
2. **File to Modify/Delete:** `frontend/src/types/api.ts`  
   * **Action:** Generate and sync TypeScript types using Zod 4.1.12 discriminated unions with codecs for data transformations like date parsing, ensuring alignment with Pydantic schema via OpenAPI spec.  
   * **Specifics:** Import: `import { z } from 'zod';`. Enum: `const TripStatus = z.enum(["active", "cancelled"]);`. Base schema: `const TripBase = z.object({ id: z.number().int().positive().describe("Unique Trip ID"), user_id: z.uuid().describe("Associated User ID"), title: z.string().min(1).max(255).describe("Trip title"), start_date: z.string().datetime().optional().describe("Trip start date"), end_date: z.string().datetime().optional().describe("Trip end date"), preferences: z.record(z.unknown()).optional().default({}).describe("User preferences"), duration_days: z.number().int().nonnegative().optional().describe("Computed duration in days") });`. Discriminated union (docs: zod.dev/?id=discriminated-unions): `const Trip = z.discriminatedUnion("status", [ z.object({ status: z.literal("active"), ...TripBase.shape }).describe("Active Trip"), z.object({ status: z.literal("cancelled"), ...TripBase.shape }).describe("Cancelled Trip") ]); export type Trip = z.infer<typeof Trip>;`. Codecs for transforms (docs: zod.dev/?id=codecs): `export const tripCodec = Trip.pipe( z.object({}).transform((data) => ({ ...data, formattedStart: data.start_date ? new Date(data.start_date) : undefined, formattedEnd: data.end_date ? new Date(data.end_date) : undefined })) );`. OpenAPI sync: Run `npx openapi-typescript http://localhost:8000/openapi.json --output src/types/generated/api.ts` (docs: openapi-typescript.dev); merge: `import type { Trip as OpenApiTrip } from './generated/api'; // Extend if needed`. Usage in components: `const parsed = Trip.safeParse(response); if (!parsed.success) { console.error(parsed.error); return; } const transformed = tripCodec.parse(parsed.data);`.  
3. **File to Modify/Delete:** `tripsage/api/routers/trips.py`  
   * **Action:** Update endpoints to use unified TripResponse model with Supabase 2.76.1 RLS enforcement, removing any custom auth logic and ensuring async operations.  
   * **Specifics:** Imports: `from supabase import create_client; from fastapi import Depends, HTTPException; from sqlalchemy.ext.asyncio import AsyncSession; supabase = create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_SERVICE_KEY")); async def get_current_user(request: Request): token = request.headers.get("Authorization", "").replace("Bearer ", ""); if not token: raise HTTPException(401, "Unauthorized"); result = await supabase.auth.get_user(token); if not result.data.user: raise HTTPException(401, "Invalid token"); return result.data.user; @router.post("/trips", response_model=TripResponse) async def create_trip(request: TripCreate, user=Depends(get_current_user), db: AsyncSession = Depends(get_async_db)): trip_data = request.model_dump(); trip_data["user_id"] = user.id; trip = TripDB(**trip_data); db.add(trip); await db.commit(); await db.refresh(trip); return TripResponse.from_orm(trip); @router.get("/trips", response_model=List[TripResponse]) async def get_trips(user=Depends(get_current_user), db: AsyncSession = Depends(get_async_db)): from sqlalchemy import select; from sqlalchemy.orm import selectinload; trips = await db.execute(select(TripDB).options(selectinload(TripDB.user)).where(TripDB.user_id == user.id)); return [TripResponse.from_orm(trip) for trip in trips.scalars()];`. RLS verification (docs: supabase.com/docs/guides/auth/row-level-security): Ensure policies: `CREATE POLICY "Users read own trips" ON trips FOR SELECT USING (auth.uid() = user_id); CREATE POLICY "Users insert own trips" ON trips FOR INSERT WITH CHECK (auth.uid() = user_id); CREATE POLICY "Users update own trips" ON trips FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id); CREATE POLICY "Users delete own trips" ON trips FOR DELETE USING (auth.uid() = user_id);` (run in Supabase SQL editor/dashboard).  

## Code Quality & Standards Enforcement  

After making the code changes, you must perform the following:  

* Run `ruff format .` and `ruff check --fix .` to apply auto-formatting and linting across all directories (docs: docs.astral.sh/ruff; rules: E4,E7,E9,F,I,UP,ARG,LOG,TRY for errors, imports, upgrades, args, logging, exceptions; target-version="py313"; fixable=["ALL"]).  
* Run `pylint tripsage_core/ tripsage/` and resolve **100%** of all reported errors and warnings in backend (tool.pylint in pyproject.toml: score=true, py-version="3.13"); for frontend, run `biome check src --apply` (docs: biomejs.dev/guides/migrate-from-eslint-and-prettier; replaces ESLint/Prettier).  
* Ensure all new/modified functions/methods have strict, complete type hints (Python: `typing`/`Annotated`/`Literal`; TS: full Zod-inferred interfaces with `z.infer<typeof Trip>`).  
* Ensure all public functions, methods, classes, and components have Google-style docstrings (Python) or JSDoc (frontend), with exactly one blank line after the closing `"""` or `*/` (Ruff D rules enforce pydocstyle "google").  

## Testing Requirements  

1. **Delete Obsolete Tests:** Delete `tests/tripsage/api/test_trips_schemas.py` and `frontend/src/__tests__/oldTrip.spec.ts` as they correspond to deleted/duplicated code.  
2. **Rewrite/Update Tests:** Open `tests/tripsage_core/test_models.py` and add unit tests for unified `TripResponse` serialization/deserialization with discriminated unions: `import pytest; from tripsage_core.models.trip import TripResponse, TripStatus; @pytest.mark.parametrize("status", [TripStatus.ACTIVE, TripStatus.CANCELLED]) def test_trip_union(status): data = {"status": status.value, "title": "Test", "user_id": "uuid", "id": 1}; trip = TripResponse.model_validate(data); assert trip.status == status; assert trip.title == "Test";` (Pytest 8.4.2 async if needed: pytest-asyncio 1.2.0). In `frontend/src/__tests__/types.test.ts` (Vitest 4.0.1), update integration tests: `import { expect, test, vi } from 'vitest'; import { Trip, tripCodec } from '../types/api'; vi.mock('@supabase/supabase-js'); test('Trip discriminated union', () => { const active = Trip.parse({ status: 'active', title: 'Test', user_id: 'uuid', id: 1, start_date: '2025-01-01T00:00:00Z' }); expect(active.status).toBe('active'); const transformed = tripCodec.parse(active); expect(transformed.formattedStart).toBeInstanceOf(Date); expect(transformed.formattedStart?.toISOString()).toBe('2025-01-01T00:00:00.000Z'); const invalid = Trip.safeParse({ status: 'invalid' }); expect(invalid.success).toBe(false); });` (docs: vitest.dev/guide; mock Supabase for auth). For RLS, add integration test in `tests/integration/test_rls.py`: `import pytest; from httpx import AsyncClient; @pytest.mark.asyncio async def test_create_trip_rls(client: AsyncClient): # Mock invalid token response = await client.post("/trips", json={"title": "Test", "status": "active"}, headers={"Authorization": "Bearer invalid"}); assert response.status_code == 401; # Valid token (mock Supabase in fixture) response = await client.post("/trips", json={"title": "Test", "status": "active"}, headers={"Authorization": "Bearer mock-valid"}); assert response.status_code == 201; assert response.json()["status"] == "active";` (Pytest-httpx 0.35.0 for async client; cov via pytest-cov 7.0.0).  
3. **Verify Coverage:** Run `pytest tripsage_core/ tripsage/ --cov` (pytest-cov 7.0.0; thresholds 90%+ lines/functions/branches; report html/xml) and `vitest run --coverage` (Vitest 4.0.1 v8 provider; thresholds 95%+; reporter html/json); ensure >95% coverage for modified paths and all integrations (include Supabase mocks).  
4. **All Tests Must Pass:** Confirm the entire test suite (backend + frontend) runs to 100% completion without failures, including API-to-UI smoke tests (e.g., Playwright 1.56.1: `await page.goto('/trips'); await page.fill('#trip-title', 'Test'); await page.click('button[type="submit"]'); await expect(page.locator('[data-status="active"]')).toBeVisible();` for E2E RLS flow; docs: playwright.dev/docs/test-essentials).  

## Documentation Updates  

1. **README.md:** Update 'Data Models' section to describe unified `TripResponse` Pydantic 2.12.3 discriminated union with Zod 4.1.12 sync via OpenAPI, Supabase 2.76.1 RLS policies, and example usage: "Models use strict ConfigDict; validate with TripResponse.model_validate(data); frontend: Trip.parse(response) with tripCodec for dates."  
2. **CHANGELOG.md:** Add the following entry under a "Refactor" section:  

   ```markdown  
   - **[Trip Models & Integrations]:** Unified representations into Pydantic 2.12.3 strict/discriminated model with Zod 4.1.12 sync (unions/codecs), Supabase 2.76.1 RLS on all ops, reducing duplication by 40% and enabling type-safe async flows.  
   ```  

3. **docs/architecture.md:** Add Mermaid diagram of updated backend-frontend data flow: "graph TD; API[FastAPI Endpoint] -->|TripCreate| DB[Supabase Postgres w/ RLS]; DB -->|Eager Load| Model[Pydantic TripResponse Union]; Model -->|OpenAPI| TS[Zod Trip Discriminated]; TS -->|Codec Transform| UI[React Component]; UI -->|Mutation| API;" (include RLS policy examples).

## Verification  

All trip-related endpoints in `tripsage/api/routers/trips.py` return `TripResponse` union; frontend components parse/transform without type errors (Zod safeParse success); Supabase RLS blocks unauthorized (logs 403 on invalid user_id); benchmarks show 20% faster serialization (Pydantic V2); Ruff/Biome clean; Vitest/Playwright/Pytest pass with 95%+ coverage (mocks for Supabase/OpenAPI). Run `uv run python -m tripsage.api.main` and `npm run dev` to verify end-to-end.
