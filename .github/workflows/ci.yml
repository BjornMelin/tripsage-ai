name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'public/**'
      - 'scripts/**'
      - 'docs/**'
      - '.github/workflows/**'
      - '.github/ci-config.yml'
      - '.pre-commit-config.yaml'
      # Root config files (post-flattening)
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - 'vitest.config.ts'
      - 'biome.json'
      - 'next.config.ts'
      - 'tailwind.config.mjs'
      - 'postcss.config.mjs'
      - 'playwright.config.ts'
      - 'vercel.json'
      - 'components.json'
      - '.npmrc'
      - '.nvmrc'
      - 'Dockerfile*'
      - 'README.md'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'public/**'
      - 'scripts/**'
      - 'docs/**'
      - '.github/workflows/**'
      - '.github/ci-config.yml'
      - '.pre-commit-config.yaml'
      # Root config files (post-flattening)
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - 'vitest.config.ts'
      - 'biome.json'
      - 'next.config.ts'
      - 'tailwind.config.mjs'
      - 'postcss.config.mjs'
      - 'playwright.config.ts'
      - 'vercel.json'
      - 'components.json'
      - '.npmrc'
      - '.nvmrc'
      - 'Dockerfile*'
      - 'README.md'
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  frontend:
    name: Frontend (lint, type, unit - quick)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Fetch main for diff checks
        run: git fetch --no-tags origin main

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Install deps
        run: |
          npm install -g pnpm@10.27.0
          pnpm install --frozen-lockfile

      - name: Cache Vite/Vitest/TS caches
        uses: ./.github/actions/cache-vite-vitest

      - name: Biome fix (must be clean)
        run: pnpm biome:fix

      - name: Fail if Biome introduced diffs
        run: git diff --exit-code

      - name: TypeScript type check
        run: pnpm type-check

      - name: Reject unknown casts (full scan)
        run: pnpm check:no-unknown-casts

      - name: Reject new unknown casts
        run: pnpm check:no-new-unknown-casts

      - name: Reject @fileoverview drift (changed files)
        run: pnpm check:fileoverviews

      - name: Reject secrets (PR diff)
        if: github.event_name == 'pull_request'
        run: pnpm check:no-secrets

      - name: Reject secrets (full scan)
        if: github.event_name != 'pull_request'
        run: pnpm check:no-secrets:full

      - name: Architecture boundary checks
        run: pnpm boundary:check

      - name: Reject new Domain → Lib/Infra imports
        run: pnpm check:no-new-domain-infra-imports

      - name: AI tool guardrails check
        run: pnpm ai-tools:check

      - name: Dependency cycle check (AI agents)
        run: pnpm deps:cycles

      - name: Production build
        run: pnpm build
        env:
          # Stub required env vars for build (no secrets needed)
          NEXT_PUBLIC_SITE_URL: 'https://example.com'
          NEXT_PUBLIC_SUPABASE_URL: 'https://abcd1234.supabase.co'
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: 'sb_publishable_dummy'

      - name: Unit tests (affected)
        env:
          VITEST_POOL: threads
        run: pnpm test:affected

      - name: Determine if prod CSP check needed
        id: prod_csp
        run: |
          if git diff --name-only origin/main...HEAD | grep -Eq '^(src/proxy\\.ts|playwright\\.prod\\.config\\.ts|scripts/e2e-webserver-prod\\.mjs|package\\.json|pnpm-lock\\.yaml|next\\.config\\.ts)$'; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Playwright Chromium (prod CSP)
        if: steps.prod_csp.outputs.run == 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Prod CSP E2E (chromium)
        if: steps.prod_csp.outputs.run == 'true'
        run: pnpm exec playwright test -c playwright.prod.config.ts
        env:
          E2E_SKIP_BUILD: "1"

      - name: Performance benchmarks
        continue-on-error: true
        run: pnpm test:benchmark || true

      - name: Analyze test failures
        if: failure()
        continue-on-error: true
        run: |
          echo "## Test Failure Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -f .vitest-reports/vitest-report.json ]; then
            pnpm test:analyze 2>&1 | head -100 >> $GITHUB_STEP_SUMMARY || true
          else
            echo "No test report found - run pnpm test:benchmark first" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: benchmark-summary.json
          if-no-files-found: ignore

      - name: Check performance thresholds
        if: >-
          github.event_name == 'push' && startsWith(github.ref, 'refs/heads/main')
        run: |
          if [ -f benchmark-summary.json ]; then
            SUITE_DURATION=$(jq -r '.suite.duration' benchmark-summary.json)
            SUITE_PASSED=$(jq -r '.thresholds.suitePassed' benchmark-summary.json)
            EXCEEDED_COUNT=$(jq -r '.thresholds.exceeded | length' benchmark-summary.json)

            if [ "$SUITE_PASSED" = "false" ] || [ "$EXCEEDED_COUNT" -gt 0 ]; then
              echo "❌ Performance thresholds exceeded"
              echo "Suite duration: ${SUITE_DURATION}ms (threshold: 10000ms)"
              jq -r '.thresholds.exceeded[]' benchmark-summary.json
              exit 1
            else
              echo "✅ Performance thresholds met"
            fi
          else
            echo "⚠️  Benchmark summary not found, skipping threshold check"
          fi

      - name: Summary
        run: |
          echo "## Frontend CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "Biome lint, TS check, and unit tests completed." >> $GITHUB_STEP_SUMMARY
          if [ -f benchmark-summary.json ]; then
            echo "Performance benchmarks: completed" >> $GITHUB_STEP_SUMMARY
          fi

  frontend-coverage:
    name: Frontend Coverage (sharded)
    needs: frontend
    if: >-
      github.event_name == 'push' && startsWith(github.ref, 'refs/heads/main')
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
        total: [4]
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Install deps
        run: |
          npm install -g pnpm@10.27.0
          pnpm install --frozen-lockfile

      - name: Cache Vite/Vitest/TS caches
        uses: ./.github/actions/cache-vite-vitest

      - name: Run sharded coverage (api+ui)
        env:
          CI: '1'
        run: >-
          pnpm vitest run --coverage
          --pool=threads --reporter=blob --outputFile=.vitest/shard-${{ matrix.shard }}.json
          --shard=${{ matrix.shard }}/${{ matrix.total }}

      - name: Upload shard artifacts
        uses: actions/upload-artifact@v6
        with:
          name: vitest-reports-${{ matrix.shard }}
          path: |
            .vitest
            coverage
          if-no-files-found: warn

  frontend-coverage-merge:
    name: Frontend Coverage (merge)
    needs: frontend-coverage
    if: ${{ needs.frontend-coverage.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Install dependencies
        run: |
          npm install -g pnpm@10.27.0
          pnpm install --frozen-lockfile

      - name: Download shard artifacts
        uses: actions/download-artifact@v7
        with:
          path: .vitest-merged

      - name: Merge reports
        run: |
          mkdir -p .vitest
          find .vitest-merged -type f -name "*.json" -exec cp {} .vitest/ \;
          pnpm vitest run --merge-reports

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-merged
          path: coverage
          if-no-files-found: error
