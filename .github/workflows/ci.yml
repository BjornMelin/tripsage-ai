name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'docs/**'
      - 'docs/review/**'
      - '.github/workflows/**'
      - '.github/ci-config.yml'
      - '.pre-commit-config.yaml'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'README.md'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'docs/**'
      - 'docs/review/**'
      - '.github/workflows/**'
      - '.github/ci-config.yml'
      - '.pre-commit-config.yaml'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'README.md'
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  frontend:
    name: Frontend (lint, type, unit - quick)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Install deps
        working-directory: frontend
        run: |
          npm install -g pnpm@10.20.0
          pnpm install --frozen-lockfile

      - name: Cache Vite/Vitest/TS caches
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-vite-vitest-${{ hashFiles('frontend/pnpm-lock.yaml','frontend/vitest.config.ts','frontend/tsconfig.json','frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-vite-vitest-
          path: |
            frontend/node_modules/.vite
            frontend/node_modules/.vitest
            frontend/tsconfig.tsbuildinfo

      - name: Biome check (src + e2e + scripts)
        working-directory: frontend
        run: npx biome check ./src ./e2e ./scripts --reporter=github

      - name: TypeScript type check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Unit tests (quick, no coverage)
        working-directory: frontend
        env:
          VITEST_POOL: threads
        run: pnpm test:quick

      - name: Performance benchmarks
        working-directory: frontend
        continue-on-error: true
        run: pnpm test:benchmark || true

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-results
          path: frontend/benchmark-summary.json
          if-no-files-found: ignore

      - name: Check performance thresholds
        if: >-
          github.event_name == 'push' && startsWith(github.ref, 'refs/heads/main')
        working-directory: frontend
        run: |
          if [ -f benchmark-summary.json ]; then
            SUITE_DURATION=$(jq -r '.suite.duration' benchmark-summary.json)
            SUITE_PASSED=$(jq -r '.thresholds.suitePassed' benchmark-summary.json)
            EXCEEDED_COUNT=$(jq -r '.thresholds.exceeded | length' benchmark-summary.json)
            
            if [ "$SUITE_PASSED" = "false" ] || [ "$EXCEEDED_COUNT" -gt 0 ]; then
              echo "❌ Performance thresholds exceeded"
              echo "Suite duration: ${SUITE_DURATION}ms (threshold: 10000ms)"
              jq -r '.thresholds.exceeded[]' benchmark-summary.json
              exit 1
            else
              echo "✅ Performance thresholds met"
            fi
          else
            echo "⚠️  Benchmark summary not found, skipping threshold check"
          fi

      - name: Summary
        run: |
          echo "## Frontend CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "Biome lint, TS check, and unit tests completed." >> $GITHUB_STEP_SUMMARY
          if [ -f frontend/benchmark-summary.json ]; then
            echo "Performance benchmarks: completed" >> $GITHUB_STEP_SUMMARY
          fi

  frontend-coverage:
    name: Frontend Coverage (sharded)
    needs: frontend
    if: >-
      github.event_name == 'push' && startsWith(github.ref, 'refs/heads/main')
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
        total: [4]
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Install deps
        working-directory: frontend
        run: |
          npm install -g pnpm@10.20.0
          pnpm install --frozen-lockfile

      - name: Cache Vite/Vitest/TS caches
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-vite-vitest-${{ hashFiles('frontend/pnpm-lock.yaml','frontend/vitest.config.ts','frontend/tsconfig.json','frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-vite-vitest-
          path: |
            frontend/node_modules/.vite
            frontend/node_modules/.vitest
            frontend/tsconfig.tsbuildinfo

      - name: Run sharded coverage (api+ui)
        working-directory: frontend
        env:
          CI: '1'
        run: >-
          pnpm vitest run --coverage
          --pool=threads --reporter=blob --outputFile=.vitest/shard-${{ matrix.shard }}.json
          --shard=${{ matrix.shard }}/${{ matrix.total }}

      - name: Upload shard artifacts
        uses: actions/upload-artifact@v5
        with:
          name: vitest-reports-${{ matrix.shard }}
          path: |
            frontend/.vitest
            frontend/coverage
          if-no-files-found: warn

  frontend-coverage-merge:
    name: Frontend Coverage (merge)
    needs: frontend-coverage
    if: ${{ needs.frontend-coverage.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Install vitest (frontend)
        working-directory: frontend
        run: |
          npm install -g pnpm@10.20.0
          pnpm install --frozen-lockfile

      - name: Download shard artifacts
        uses: actions/download-artifact@v4
        with:
          path: frontend/.vitest-merged

      - name: Merge reports
        working-directory: frontend
        run: |
          mkdir -p .vitest
          find .vitest-merged -type f -name "*.json" -exec cp {} .vitest/ \;
          pnpm vitest run --merge-reports

      - name: Upload coverage report
        uses: actions/upload-artifact@v5
        with:
          name: coverage-merged
          path: frontend/coverage
          if-no-files-found: error
